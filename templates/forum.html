{% extends '_template.html' %}

{% block head %}
<title>ForTheBoard - GuildBoard</title>
{% endblock %} 

{% block body %}
{% from 'forum/_macros.html' import forum_style, post_header, post_body, post_footer, topic_card %}
{{ forum_style() }}

<div class="container-fluid">
	<div class="row">
		<div class="col-3">
		{% include "forum/_forumtopics.html" %}
		{% include "forum/_forumsearch.html" %}
		</div>
		<div class="col-6">
		{% for post in posts %}
		{% include "forum/_forumpost.html" %}
		{% endfor %}
		</div>
		<div class="col-3">
		{% set forum_name='Main' %}
		{{ topic_card(forum_name) }}
		</div>
	</div>
</div>

<script>
	/* Modify timestamps on post to reflect M-D-Y H:M AM/PM according to client's local time */
	const timePostedElements = document.getElementsByClassName('time_posted');

	for (let i = 0; i < timePostedElements.length; i++) {
		const timePostedElement = timePostedElements[i];
		const utcTime = timePostedElement.textContent + 'Z';  // Append 'Z' to treat as UTC
		const date = new Date(utcTime);

		// Format the dates and times as "month-day-year hour:minute AM/PM" of local client time
		let hours = date.getHours();
		let minutes = date.getMinutes();
		const ampm = hours >= 12 ? 'PM' : 'AM';
		hours = hours % 12;
		hours = hours ? hours : 12; // Display hour '0' as '12'
		minutes = minutes < 10 ? '0'+minutes : minutes;
		const formattedDate = (date.getMonth() + 1).toString().padStart(2, '0') + "-"
			+ date.getDate().toString().padStart(2, '0') + "-"
			+ date.getFullYear() + " "
			+ hours + ":"
			+ minutes + " " + ampm;

		timePostedElement.textContent = formattedDate;
	}

	/* Upvote functionality */
	document.querySelectorAll('.upvote-button').forEach(function(button) {
		button.addEventListener('click', function(event) {
			event.preventDefault();
			const button = event.target;
			if (button.tagName !== 'BUTTON') {
				button = button.parentNode;
			}
			const postId = event.target.getAttribute('data-post-id');
			fetch('/upvote', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ post_id: postId }),
			})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const countSpan = event.target.parentNode.querySelector('.upvotes-count');
						countSpan.textContent = parseInt(countSpan.textContent, 10) + 1;
					}
				});
		});
	});

	/* Downvote functionality */
	document.querySelectorAll('.downvote-button').forEach(function(button) {
		button.addEventListener('click', function(event) {
			event.preventDefault();
			const button = event.target;
			if (button.tagName !== 'BUTTON') {
				button = button.parentNode;
			}
			const postId = event.target.getAttribute('data-post-id');
			const countSpan = button.parentNode.querySelector('.upvotes-count');
			const currentCount = parseInt(countSpan.textContent, 10);
			if (currentCount > 0) {
				fetch('/downvote', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ post_id: postId }),
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						countSpan.textContent = currentCount - 1;
					}
				});
			}
		});
	});

	/* Share button initiates a popup with link to single post */
	const shareButtons = document.querySelectorAll(".share-button"); 
	const copyButtons = document.querySelectorAll(".copy-button"); 
	const popups = document.querySelectorAll(".popup");

	shareButtons.forEach((button, index) => { button.addEventListener("click", () => { popups[index].querySelector(".popup-content").classList.toggle("show"); 
	}); 
});

	copyButtons.forEach((button, index) => { button.addEventListener("click", () => { const input = popups[index].querySelector(".link-input");
		input.select(); 
		document.execCommand("copy"); 
		button.innerText = "Copied!"; 
		setTimeout(() => { button.innerText = "Copy"; 
		}, 2000); 
	}); 
});
	const closeButton = document.querySelector(".close-button"); 
	closeButtons.forEach((button) => { button.addEventListener("click", function() { this.parentElement.parentElement.classList.remove("show"); 
	}); 
});

	/* Delete post functionality for post author */
	function deletePost(event) {
		const postId = event.currentTarget.dataset.postId;
		const result = confirm("Post deletion is irreversible. Are you sure you want to delete this post?");
		if (result) {
			const form = document.querySelector("form[action='/delete_post/" + postId + "']");
			form.submit();
		} else {
			event.preventDefault();
		}
	}
</script>

{% endblock %}