{% extends '_template.html' %} {% block head %}

<title>ForTheBoard - GuildBoard</title>

{% endblock %} 

{% block body %}
<style>
	.card-header {
		background-color: #000419;
		color: #ffffff;
	}
	.card {
		margin-top: 20px;
		background-color: #202428;
		color: #ffffff;
	}
	.card-footer {
		background-color: #000419;
		color: #ffffff;
		display: flex;
	}
	.form-control {
		margin-bottom: 15px;
	}
	.btn.btn-primary.btn-block {
		background-color: #944394;
		border-color: #944394;
		color: #ffffff;
	}
	.btn.btn-light.btn-sm {
		background-color: #a2d0f7;
		border-color: #a2d0f7;
		margin-right: 5px;
	}
	.btn.btn-light.btn-sm.upvote-button {
		background-color: #944394;
		border-color: #944394;
		margin-right: 5px;
	}
	.btn.btn-light.btn-sm.downvote-button {
		background-color: #944394;
		border-color: #944394;
		margin-left: 5px;
	}
	.btn.btn-secondary {
		background-color: #6a84da;
		border-color: #6a84da;
		color: #ffffff;
	}
</style>

<div class="container-fluid">
	<div class="row">
		<div class="col-3">
			<div class="card">
				<div class="card-body">
					<h5 cdivlass="card-title">Boards by Topic</h5>
					<div class="card-link d-flex flex-column">
						<a href="{{ url_for('subforum', category='community-square') }}" class="subforum-link">Community Square</a>
						<a href="{{ url_for('subforum', category='looking-for-group') }}" class="subforum-link">Looking For Group</a>
						<a href="{{ url_for('subforum', category='creative-content') }}" class="subforum-link">Creative Content</a>
						<a href="{{ url_for('subforum', category='gamemaster-corner') }}" class="subforum-link">Gamemasters Corner</a>
						<a href="{{ url_for('subforum', category='bug-report-technical') }}" class="subforum-link">Bug Report & Technical Issues</a>
					</div>
				</div>
			</div>
			<div class="card">
				<div class="card-body">
					<form action="{{ url_for('search_posts' )}}" method="get">
						<div class="mb-3">
							<label for="search" name="query-flair" class="form-label"></label>
							<input type="text" name="query-flair" placeholder="Search by flair" class="form-control">
							<button type="submit" class="btn btn-secondary">Search</button>
						</div>
					</form>
				</div>
			</div>
			<div class="card">
				<div class="card-body">
					<form action="{{ url_for('search_posts' )}}" method="get">
						<div class="mb-3">
							<label for="search" name="query-title" class="form-label"></label>
							<input type="text" name="query-title" placeholder="Search by title..." class="form-control">
							<button type="submit" class="btn btn-secondary">Search</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="col-6">
			{% for post in posts %}
			<div class="card">
				<div class="card-header">
					<strong>
						<button class="btn btn-light btn-sm upvote-button" data-post-id="{{ post.get_post_id() }}">
							<i class="fas fa-arrow-up"></i>
						</button>
							<span class="upvotes-count">{{ post.get_upvotes() }}</span>
						<button class="btn btn-light btn-sm downvote-button" data-post-id="{{ post.get_post_id() }}">
							<i class="fas fa-arrow-down"></i>
						</button>
					</strong>
					ftb/GuildBoard â€¢
					<span class="text" style="font-size: 10pt; color: #ffffff">
						Posted by u/{{ post.author.username }} at <span class="time_posted">{{ post.get_time_posted() }}</span>
					</span>
				</div>
				<div class="card-body">
					<h5 class="card-title">{{ post.get_title() }}</h5>
					{% if post.get_flairs() %}
					<div class="post-flairs">
						{% for flair in post.get_flairs().split(',') %}
						<span class="badge rounded-pill text-bg-primary">{{ flair }}</span>
						{% endfor %}
					</div>
					{% endif %}

					<p class="card-text">{{ post.get_content() | safe }}</p>
				</div>
				<div class="card-footer text-muted">
					<a href="" class="btn btn-light btn-sm"><i class="fas fa-comment"></i> 0 Comments</a>
					<a href="" class="btn btn-light btn-sm"><i class="fas fa-share"></i> Share</a>
					{% if session['username'] == post.author.username %}
					<a href="{{ url_for('edit_post', post_id=post.get_post_id()) }}" class="btn btn-light btn-sm edit-post"><i class="fas fa-edit"></i> Edit</a>
					<form method="POST" action="{{ url_for('delete_post', post_id=post.get_post_id()) }}">
						<input type="hidden" name="_method" value="DELETE">
						<button type="button" data-post-id="{{ post.get_post_id() }}" class="btn btn-light btn-sm delete-post" onclick="deletePost(event)"><i class="fas fa-trash"></i> Delete</button>
					</form>
					{% endif %}
				</div>
			</div>
			{% endfor %}
		</div>
		<div class="col-3">
			<div class="card">
				<div class="card-body">
					<h5 class="card-title">ftb/GuildBoard</h5>
					<p class="card-text">
						Lorem ipsum dolor sit amet consectetur adipisicing elit. Dignissimos aspernatur omnis,
						perferendis fuga quaerat ex, id sed dolores minus dolorum veritatis dolor commodi voluptates,
						praesentium beatae error consectetur hic. Fuga consequuntur illo odit sit eveniet laudantium?
						Impedit laboriosam mollitia ut iusto harum voluptates, nostrum nam esse tempora facilis
						cupiditate.
					</p>
					<a href="/create_post" class="btn btn-primary btn-block">Create Post</a>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- JavaScript elements-->
<script>
	const timePostedElements = document.getElementsByClassName('time_posted');

	for (let i = 0; i < timePostedElements.length; i++) {
		const timePostedElement = timePostedElements[i];
		const utcTime = timePostedElement.textContent + 'Z';  // Append 'Z' to treat as UTC
		const date = new Date(utcTime);

		// Format the dates and times as "month-day-year hour:minute AM/PM" of local client time
		let hours = date.getHours();
		let minutes = date.getMinutes();
		const ampm = hours >= 12 ? 'PM' : 'AM';
		hours = hours % 12;
		hours = hours ? hours : 12; // the hour '0' should be '12'
		minutes = minutes < 10 ? '0'+minutes : minutes;
		const formattedDate = (date.getMonth() + 1).toString().padStart(2, '0') + "-"
			+ date.getDate().toString().padStart(2, '0') + "-"
			+ date.getFullYear() + " "
			+ hours + ":"
			+ minutes + " " + ampm;

		timePostedElement.textContent = formattedDate;
	}

	document.querySelectorAll('.upvote-button').forEach(function(button) {
		button.addEventListener('click', function(event) {
			event.preventDefault();
			const button = event.target;
			if (button.tagName !== 'BUTTON') {
				button = button.parentNode;
			}
			const postId = event.target.getAttribute('data-post-id');
			fetch('/upvote', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ post_id: postId }),
			})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const countSpan = event.target.parentNode.querySelector('.upvotes-count');
						countSpan.textContent = parseInt(countSpan.textContent, 10) + 1;
					}
				});
		});
	});

	document.querySelectorAll('.downvote-button').forEach(function(button) {
		button.addEventListener('click', function(event) {
			event.preventDefault();
			const button = event.target;
			if (button.tagName !== 'BUTTON') {
				button = button.parentNode;
			}
			const postId = event.target.getAttribute('data-post-id');
			const countSpan = button.parentNode.querySelector('.upvotes-count');
			const currentCount = parseInt(countSpan.textContent, 10);
			if (currentCount > 0) {
				fetch('/downvote', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ post_id: postId }),
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						countSpan.textContent = currentCount - 1;
					}
				});
			}
		});
	});

	function deletePost(event) {
		const postId = event.currentTarget.dataset.postId;
		const result = confirm("Post deletion is irreversible. Are you sure you want to delete this post?");
		if (result) {
			const form = document.querySelector("form[action='/delete_post/" + postId + "']");
			form.submit();
		} else {
			event.preventDefault();
		}
	}
</script>

{% endblock %}
